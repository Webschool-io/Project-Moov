#!/usr/bin/env node
"use strict";

var https    = require('https');
var inquirer = require('inquirer');
var program  = require('commander');
var shell    = require('shelljs');

var search   = 'https://yts.ag/api/v2/list_movies.json?query_term=';
var details	 = 'https://yts.ag/api/v2/movie_details.json?movie_id=';

program
	.version('[0.0.1] - MoviesCLI')
	.command('search <movie>')
	.description('Search for a movie')
	.action(function (movie) {
		searchResponse(movie);
	});

// Request using https protocol
var request = function (url, callback) {
	https.get(url, function (response) {
		var data = '';

		response.on('data', function (newData) {
			data += newData;
		});

		response.on('end', function () {
			callback(data);
		});
	});
}

// List movies for search
var searchResponse = function (terms) {
	request(search + encodeURI(terms), function (data) {
		makeList(JSON.parse(data).data.movies, selectQuality);
	});
}

// Make a list
var makeList = function (object, callback) {
	var list = [];

	for (var i in object) {
		list.push({
			'name' : object[i].title_long,
			'value': object[i].id
		});
	}

	inquirer.prompt([
		{
			type    : 'list',
			name    : 'movie',
			message : 'Select your movies: ',
			choices : list,
			default : 0
		}
	]).then(function (answers) {

		if (typeof callback == 'function') {
			callback(answers);
		}
	});
};

// Select a quality for movie
var selectQuality = function (object) {
	var movieID = object.movie;

	request(details + movieID, function (response) {
		response = JSON.parse(response).data;

		var movie    = response.movie;
		var torrents = movie.torrents;
		var list     = [];

		for (var i in torrents) {
			list.push({
				name  : torrents[i].quality,
				value : torrents[i].url 
			})
		};

		inquirer.prompt([
			{
				type    : 'list',
				name    : 'torrent',
				message : 'Available qualities for: ' + movie.title_long,
				choices : list,
				default : 0
			}
		]).then(function (answers) {
			streamMovie(answers.torrent);
		});

	});
};

// Stream movie from a torrentURL
var streamMovie = function (torrentURL) {
	shell.exec('peerflix ' + torrentURL + ' --vlc');
}

program.parse(process.argv);
